<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MMORPG Admin</title>
  <style>
    :root { --bg:#0f0f0f; --card:#1a1a1a; --text:#fff; --muted:#bbb; --btn:#111; --btnAccent:#222; --ok:#0f0; --err:#f66; }
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:900px;margin:24px auto;padding:0 12px}
    h1{margin:0 0 16px 0}
    .card{background:var(--card);border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 0 0 1px #000 inset}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>*{flex:1 1 160px}
    button{background:#000;border:1px solid #333;color:#fff;border-radius:10px;padding:10px 14px;font-size:16px;cursor:pointer}
    button.primary{background:#111}
    button.accent{background:#222}
    button.danger{background:#400}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid #333;background:#0c0c0c;color:#fff;font-size:16px}
    .label{font-size:12px;color:var(--muted);margin:8px 0 4px}
    pre#out{background:#000;color:#9f9;border-radius:12px;padding:12px;min-height:56px;white-space:pre-wrap}
  </style>
</head>
<body>
<div class="wrap">
  <h1>MMORPG Admin</h1>

  <!-- Clave -->
  <div class="card">
    <div class="label">Admin secret</div>
    <input id="secret" type="password" placeholder="Escribe tu clave de admin" />
    <div class="row" style="margin-top:10px">
      <button type="button" id="btnSaveKey" class="primary">Guardar clave</button>
      <button type="button" id="btnForgetKey" class="accent">Olvidar clave</button>
    </div>
    <div class="label">La clave se envía en el header <code>x-admin-secret</code> y se guarda localmente.</div>
  </div>

  <!-- Progreso global -->
  <div class="card">
    <h2 style="margin-top:0">Progreso global</h2>
    <div class="row">
      <button type="button" id="btnGet"  class="primary">Ver progreso</button>
      <button type="button" id="btnPlus5"  class="accent">+5</button>
      <button type="button" id="btnPlus100" class="accent">+100</button>
    </div>

    <div class="label">current</div><input id="g_current" type="number" value="0" />
    <div class="label">goal</div>   <input id="g_goal"    type="number" value="10000" />
    <div class="label">stage</div>  <input id="g_stage"   type="number" value="0" />
    <div style="margin-top:10px">
      <button type="button" id="btnSaveGlobal" class="primary" style="width:100%">Guardar</button>
    </div>
  </div>

  <!-- Jugadores -->
  <div class="card">
    <h2 style="margin-top:0">Jugadores</h2>
    <div class="row">
      <button type="button" id="btnList" class="primary">Listar</button>
      <button type="button" id="btnTop"  class="accent">Top 10 (XP)</button>
    </div>

    <div class="label">name (único)</div><input id="p_name"  placeholder="Jugador1" />
    <div class="label">level</div>        <input id="p_level" type="number" value="1" />
    <div class="label">xp (opcional)</div><input id="p_xp"    type="number" value="0" />

    <div class="row" style="margin-top:10px">
      <button type="button" id="btnUpsert" class="primary">Crear/Actualizar</button>
      <button type="button" id="btnAddXp"  class="accent">+50 XP</button>
      <button type="button" id="btnDel"    class="danger">Borrar jugador</button>
    </div>
  </div>

  <!-- Salida -->
  <div class="card">
    <h2 style="margin:0 0 8px 0">Salida</h2>
    <pre id="out">—</pre>
  </div>
</div>

<script>
  // ===== util =====
  const $ = s => document.querySelector(s);
  const out = $('#out');
  const SECRET_KEY = 'admin_secret';

  function log(obj, isErr=false){
    try{
      out.style.color = isErr ? '#f99' : '#9f9';
      out.textContent = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2);
    }catch(e){ out.textContent = String(obj); }
  }
  function getSecret(){ return localStorage.getItem(SECRET_KEY) || ''; }
  function setSecret(v){ localStorage.setItem(SECRET_KEY, v||''); }

  // Mostrar secreto guardado
  $('#secret').value = getSecret();

  async function api(path, options={}){
    const headers = options.headers || {};
    const sec = getSecret();
    if (sec) headers['x-admin-secret'] = sec;
    headers['Content-Type'] = 'application/json';
    const res = await fetch(path, { credentials:'same-origin', ...options, headers });
    let data = null;
    const txt = await res.text();
    try { data = txt ? JSON.parse(txt) : null; } catch { data = { raw: txt }; }
    if (!res.ok) throw Object.assign(new Error('HTTP '+res.status), {status:res.status, data});
    return data ?? {};
  }

  // ===== botones clave =====
  $('#btnSaveKey').onclick   = () => { setSecret($('#secret').value.trim()); log('Clave guardada'); };
  $('#btnForgetKey').onclick = () => { setSecret(''); $('#secret').value=''; log('Clave borrada'); };

  // ===== global =====
  $('#btnGet').onclick = async () => {
    try {
      const g = await api('/global');
      $('#g_current').value = g.current ?? 0;
      $('#g_goal').value    = g.goal ?? 10000;
      $('#g_stage').value   = g.stage ?? 0;
      log(g);
    } catch(e){ log(e.data || e.message, true); }
  };

  $('#btnPlus5').onclick = () => { $('#g_current').value = (+$('#g_current').value||0) + 5; };
  $('#btnPlus100').onclick = () => { $('#g_current').value = (+$('#g_current').value||0) + 100; };

  $('#btnSaveGlobal').onclick = async () => {
    try{
      const body = {
        current: +$('#g_current').value||0,
        goal:    +$('#g_goal').value||0,
        stage:   +$('#g_stage').value||0
      };
      const r = await api('/global', { method:'PATCH', body: JSON.stringify(body) });
      log(r);
    }catch(e){ log(e.data || e.message, true); }
  };

  // ===== players =====
  $('#btnList').onclick = async () => {
    try { log(await api('/players?limit=25')); }
    catch(e){ log(e.data || e.message, true); }
  };

  $('#btnTop').onclick = async () => {
    try { log(await api('/leaderboard?limit=10')); }
    catch(e){ log(e.data || e.message, true); }
  };

  $('#btnUpsert').onclick = async () => {
    const name  = $('#p_name').value.trim();
    const level = +$('#p_level').value||1;
    const xp    = +$('#p_xp').value||0;
    if (!name) return log('name requerido', true);
    try {
      const r = await api('/players/'+encodeURIComponent(name), {
        method:'PUT',
        body: JSON.stringify({ level, xp })
      });
      log(r);
    } catch(e){ log(e.data || e.message, true); }
  };

  $('#btnAddXp').onclick = async () => {
    const name = $('#p_name').value.trim();
    if (!name) return log('name requerido', true);
    try {
      const r = await api('/players/addxp', { method:'POST', body: JSON.stringify({ name, xp:50 }) });
      log(r);
    } catch(e){ log(e.data || e.message, true); }
  };

  $('#btnDel').onclick = async () => {
    const name = $('#p_name').value.trim();
    if (!name) return log('name requerido', true);
    try {
      const r = await api('/players/delete', { method:'POST', body: JSON.stringify({ name }) });
      log(r);
    } catch(e){ log(e.data || e.message, true); }
  };
</script>
</body>
</html>
