<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MMORPG Admin</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, Arial, sans-serif; margin:16px; }
    h1{margin:0 0 16px}
    .card{border:1px solid #8884; border-radius:10px; padding:12px; margin:12px 0;}
    .row{display:flex; gap:8px; flex-wrap:wrap}
    .row>*{flex:1}
    input,button{padding:10px; border-radius:8px; border:1px solid #8884; width:100%}
    button{background:#111; color:#fff; border:none}
    pre{background:#000; color:#0f0; padding:10px; border-radius:8px; overflow:auto}
    small{opacity:.7}
  </style>
</head>
<body>
  <h1>MMORPG Admin</h1>

  <!-- Progreso global -->
  <div class="card">
    <h3>Progreso global</h3>
    <div class="row">
      <button id="btnVerGlobal">Ver progreso</button>
      <button id="btnAdd5">+5</button>
      <button id="btnAdd100">+100</button>
    </div>
    <small>current</small>
    <input id="g_current" type="number" placeholder="0" />
    <small>goal</small>
    <input id="g_goal" type="number" placeholder="10000" />
    <small>stage</small>
    <input id="g_stage" type="number" placeholder="0" />
    <div class="row">
      <button id="btnSaveGlobal">Guardar</button>
    </div>
  </div>

  <!-- Jugadores -->
  <div class="card">
    <h3>Jugadores</h3>
    <div class="row">
      <button id="btnList">Listar</button>
    </div>
    <small>name (único)</small>
    <input id="p_name" placeholder="Jugador1" />
    <small>level</small>
    <input id="p_level" type="number" placeholder="1" />
    <small>xp (opcional)</small>
    <input id="p_xp" type="number" placeholder="0" />
    <div class="row">
      <button id="btnUpsert">Crear/Actualizar</button>
    </div>
  </div>

  <div class="card">
    <h3>Salida</h3>
    <pre id="out">-</pre>
  </div>

<script>
const BASE = ""; // está en el mismo dominio (Cloud Run)

const out = (x) => {
  const pre = document.getElementById("out");
  pre.textContent = typeof x === "string" ? x : JSON.stringify(x, null, 2);
};

// Helpers
async function getJSON(path){
  const r = await fetch(BASE + path, { headers: { "Accept": "application/json" } });
  if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
  return r.json();
}
async function postJSON(path, body){
  const r = await fetch(BASE + path, {
    method: "POST",
    headers: { "Content-Type": "application/json", "Accept":"application/json" },
    body: JSON.stringify(body)
  });
  if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
  return r.json();
}

// GLOBAL
async function verGlobal(){
  try{
    const data = await getJSON("/global");
    document.getElementById("g_current").value = data.current ?? 0;
    document.getElementById("g_goal").value = data.goal ?? 10000;
    document.getElementById("g_stage").value = data.stage ?? 0;
    out(data);
  }catch(e){ out("Error GET /global -> " + e.message); }
}
async function guardarGlobal(deltaSum){
  try{
    const cur = Number(document.getElementById("g_current").value || 0) + (deltaSum||0);
    const goal = Number(document.getElementById("g_goal").value || 0);
    const stage = Number(document.getElementById("g_stage").value || 0);
    const res = await postJSON("/global", { current: cur, goal, stage });
    // recargar valores desde servidor
    await verGlobal();
    out(res);
  }catch(e){ out("Error POST /global -> " + e.message); }
}

// PLAYERS
async function listar(){
  try{ out(await getJSON("/players")); }
  catch(e){ out("Error GET /players -> " + e.message); }
}
async function upsert(){
  try{
    const name = document.getElementById("p_name").value.trim();
    const level = Number(document.getElementById("p_level").value || 1);
    const xpStr = document.getElementById("p_xp").value;
    const body = { name, level };
    if (xpStr !== "") body.xp = Number(xpStr); // opcional

    const res = await postJSON("/players/create", body);
    out(res);
  }catch(e){ out("Error POST /players/create -> " + e.message); }
}

// Eventos
document.getElementById("btnVerGlobal").onclick = verGlobal;
document.getElementById("btnSaveGlobal").onclick = () => guardarGlobal(0);
document.getElementById("btnAdd5").onclick = () => guardarGlobal(5);
document.getElementById("btnAdd100").onclick = () => guardarGlobal(100);
document.getElementById("btnList").onclick = listar;
document.getElementById("btnUpsert").onclick = upsert;

// carga inicial
verGlobal().catch(()=>{});
</script>
</body>
</html>
