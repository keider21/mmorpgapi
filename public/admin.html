<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MMORPG Admin</title>
  <style>
    :root { color-scheme: light dark; }
    body{font-family:system-ui,Arial,sans-serif;margin:16px;max-width:760px}
    h1{margin:0 0 16px}
    .card{border:1px solid #8884;border-radius:12px;padding:12px;margin:12px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .row>*{flex:1}
    input,button{padding:10px;border-radius:10px;border:1px solid #8884;font-size:16px;width:100%}
    button{background:#111;color:#fff;border:none}
    button.secondary{background:#666}
    pre{background:#000;color:#0f0;padding:12px;border-radius:10px;overflow:auto;min-height:44px}
    label{font-size:12px;opacity:.8;margin-top:4px;display:block}
  </style>
</head>
<body>
  <h1>MMORPG Admin</h1>

  <div class="card">
    <h3>Progreso global</h3>
    <div class="row">
      <button type="button" onclick="loadGlobal()">Ver progreso</button>
      <button type="button" class="secondary" onclick="saveGlobal(5)">+5</button>
      <button type="button" class="secondary" onclick="saveGlobal(100)">+100</button>
    </div>
    <label>current</label>
    <input id="g_current" type="number" inputmode="numeric" placeholder="0" />
    <label>goal</label>
    <input id="g_goal" type="number" inputmode="numeric" placeholder="10000" />
    <label>stage</label>
    <input id="g_stage" type="number" inputmode="numeric" placeholder="0" />
    <div class="row">
      <button type="button" onclick="saveGlobal(0)">Guardar</button>
    </div>
  </div>

  <div class="card">
    <h3>Jugadores</h3>
    <div class="row">
      <button type="button" onclick="listPlayers()">Listar</button>
      <button type="button" onclick="top10()">Top 10 (XP)</button>
    </div>
    <label>name (único)</label>
    <input id="p_name" placeholder="Jugador1" />
    <label>level</label>
    <input id="p_level" type="number" inputmode="numeric" placeholder="1" />
    <label>xp (opcional)</label>
    <input id="p_xp" type="number" inputmode="numeric" placeholder="0" />
    <div class="row">
      <button type="button" onclick="upsertPlayer()">Crear/Actualizar</button>
      <button type="button" class="secondary" onclick="addXp()">+50 XP</button>
      <button type="button" class="secondary" onclick="deletePlayer()">Borrar jugador</button>
    </div>
  </div>

  <div class="card">
    <h3>Salida</h3>
    <pre id="out">—</pre>
  </div>

<script>
  // Misma API (mismo dominio)
  const API = "";

  const $ = (id) => document.getElementById(id);
  const show = (x) => { $("out").textContent = typeof x === "string" ? x : JSON.stringify(x, null, 2); };

  async function getJSON(path){
    const r = await fetch(API + path, { headers: { "Accept":"application/json" }});
    if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    return r.json();
  }
  async function sendJSON(method, path, body){
    const r = await fetch(API + path, {
      method,
      headers: { "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify(body||{})
    });
    if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    return r.json();
  }

  // ---- GLOBAL ----
  async function loadGlobal(){
    try {
      const g = await getJSON("/global");
      $("g_current").value = g.current ?? 0;
      $("g_goal").value    = g.goal ?? 10000;
      $("g_stage").value   = g.stage ?? 0;
      show(g);
    } catch(e){ show("Error GET /global -> " + e.message); }
  }
  async function saveGlobal(delta=0){
    try {
      const current = Number($("g_current").value || 0) + delta;
      const goal    = Number($("g_goal").value || 0);
      const stage   = Number($("g_stage").value || 0);
      const res = await sendJSON("PATCH", "/global", { current, goal, stage });
      await loadGlobal();
      show(res);
    } catch(e){ show("Error PATCH /global -> " + e.message); }
  }

  // ---- PLAYERS ----
  async function listPlayers(){
    try { show(await getJSON("/players?limit=50")); }
    catch(e){ show("Error GET /players -> " + e.message); }
  }
  async function top10(){
    try { show(await getJSON("/leaderboard?limit=10")); }
    catch(e){ show("Error GET /leaderboard -> " + e.message); }
  }
  async function upsertPlayer(){
    try {
      const name  = $("p_name").value.trim();
      if (!name) return show("Pon un name");
      const level = Number($("p_level").value || 1);
      const xpStr = $("p_xp").value;
      const body  = {};
      if (!Number.isNaN(level)) body.level = level;
      if (xpStr !== "") body.xp = Number(xpStr);
      const res = await sendJSON("PUT", `/players/${encodeURIComponent(name)}`, body);
      show(res);
    } catch(e){ show("Error PUT /players/:name -> " + e.message); }
  }
  async function addXp(){
    try {
      const name = $("p_name").value.trim();
      if (!name) return show("Pon un name");
      const res = await sendJSON("POST", "/players/addxp", { name, xp: 50 });
      show(res);
    } catch(e){ show("Error POST /players/addxp -> " + e.message); }
  }
  async function deletePlayer(){
    try {
      const name = $("p_name").value.trim();
      if (!name) return show("Pon un name");
      const res = await sendJSON("POST", "/players/delete", { name });
      show(res);
    } catch(e){ show("Error POST /players/delete -> " + e.message); }
  }

  // Carga inicial (si falla, al menos verás el error en "Salida")
  loadGlobal().catch(()=>{});
</script>
</body>
</html>
