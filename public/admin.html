<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MMORPG Admin</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    h1 { margin: 0 0 12px; }
    .card { border: 1px solid #4443; border-radius: 10px; padding: 14px; margin: 14px 0; }
    .row { display:flex; gap:8px; flex-wrap:wrap; margin-bottom: 8px; }
    .btn { padding: 10px 14px; border: 0; border-radius: 8px; background:#111; color:#fff; }
    .btn.gray { background:#666; }
    .btn.red { background:#8b2323; }
    input { width:100%; padding:10px; border-radius:8px; border:1px solid #4443; background:transparent; }
    .log { background:#000; color:#0f0; padding:10px; border-radius:8px; min-height:48px; white-space:pre-wrap; }
    .ok { color:#0a0; }
    .bad{ color:#c33; }
    .pill { padding:4px 8px; border-radius:999px; background:#000; color:#fff; font-size:12px; }
  </style>
</head>
<body>
  <h1>MMORPG Admin</h1>

  <div class="card">
    <div class="row"><b>Admin secret</b></div>
    <div class="row">
      <input id="secret" placeholder="••••••••" />
    </div>
    <div class="row">
      <button class="btn" id="saveSecret">Guardar clave</button>
      <button class="btn gray" id="forgetSecret">Olvidar clave</button>
      <button class="btn" id="testSecret">Probar clave</button>
      <span id="secretStatus" class="pill">—</span>
    </div>
    <small>Se envía en el header <code>x-admin-secret</code> y se guarda localmente.</small>
  </div>

  <div class="card">
    <h2>Progreso global</h2>
    <div class="row">
      <button class="btn" id="btnView">Ver progreso</button>
      <button class="btn gray" id="btnPlus5">+5</button>
      <button class="btn gray" id="btnPlus100">+100</button>
    </div>
    <div class="row"><input id="gCurrent" placeholder="current" inputmode="numeric"/></div>
    <div class="row"><input id="gGoal" placeholder="goal" inputmode="numeric"/></div>
    <div class="row"><input id="gStage" placeholder="stage" inputmode="numeric"/></div>
    <div class="row"><button class="btn" id="btnSaveGlobal">Guardar</button></div>
  </div>

  <div class="card">
    <h2>Jugadores</h2>
    <div class="row">
      <button class="btn" id="btnList">Listar</button>
      <button class="btn gray" id="btnTop10">Top 10 (XP)</button>
    </div>
    <div class="row"><input id="pName" placeholder="name (único)" /></div>
    <div class="row"><input id="pLevel" placeholder="level" inputmode="numeric"/></div>
    <div class="row"><input id="pXP" placeholder="xp (opcional)" inputmode="numeric"/></div>
    <div class="row">
      <button class="btn" id="btnUpsert">Crear/Actualizar</button>
      <button class="btn gray" id="btnAddXP">+50 XP</button>
      <button class="btn red" id="btnDelete">Borrar jugador</button>
    </div>
  </div>

  <div class="card">
    <h2>Salida</h2>
    <div id="out" class="log">-</div>
  </div>

<script>
const out = (x) => {
  const el = document.getElementById("out");
  el.textContent = typeof x === "string" ? x : JSON.stringify(x, null, 2);
};

// --------- SECRET ----------
const secretInput = document.getElementById("secret");
const secretKey = "adminSecret";
function getSecret() { return (localStorage.getItem(secretKey) || "").trim(); }
function headers() {
  const s = getSecret();
  const h = { "Content-Type": "application/json" };
  if (s) h["x-admin-secret"] = s;
  return h;
}
function setSecretBadge(ok, msg) {
  const s = document.getElementById("secretStatus");
  s.textContent = msg || (ok ? "OK" : "NOK");
  s.className = "pill " + (ok ? "ok" : "bad");
}
document.getElementById("saveSecret").onclick = () => {
  localStorage.setItem(secretKey, secretInput.value.trim());
  setSecretBadge(true, "Guardada");
  out("Clave guardada.");
};
document.getElementById("forgetSecret").onclick = () => {
  localStorage.removeItem(secretKey);
  secretInput.value = "";
  setSecretBadge(false, "Borrada");
  out("Clave borrada.");
};
document.getElementById("testSecret").onclick = async () => {
  try {
    const r = await fetch("./__debug/secret", { headers: headers() });
    const j = await r.json();
    setSecretBadge(!!j.match, j.match ? "Válida" : "Inválida");
    out(j);
  } catch (e) { out(e.message); }
};
// init
secretInput.value = getSecret();

// --------- GLOBAL ----------
async function getGlobal() {
  const r = await fetch("./global");
  const j = await r.json();
  document.getElementById("gCurrent").value = j.current ?? 0;
  document.getElementById("gGoal").value = j.goal ?? 0;
  document.getElementById("gStage").value = j.stage ?? 0;
  out(j);
}
async function saveGlobal() {
  const body = {
    current: Number(document.getElementById("gCurrent").value || 0),
    goal: Number(document.getElementById("gGoal").value || 0),
    stage: Number(document.getElementById("gStage").value || 0),
  };
  const r = await fetch("./global", {
    method: "PATCH",
    headers: headers(),
    body: JSON.stringify(body)
  });
  out(await r.json());
}
document.getElementById("btnView").onclick = getGlobal;
document.getElementById("btnSaveGlobal").onclick = saveGlobal;
document.getElementById("btnPlus5").onclick = () => {
  const el = document.getElementById("gCurrent");
  el.value = Number(el.value || 0) + 5;
};
document.getElementById("btnPlus100").onclick = () => {
  const el = document.getElementById("gCurrent");
  el.value = Number(el.value || 0) + 100;
};

// --------- PLAYERS ----------
async function listPlayers() {
  const r = await fetch("./players");
  out(await r.json());
}
async function top10() {
  const r = await fetch("./leaderboard?limit=10");
  out(await r.json());
}
async function upsertPlayer() {
  const name = document.getElementById("pName").value.trim();
  const level = Number(document.getElementById("pLevel").value || 1);
  const xpVal = Number(document.getElementById("pXP").value || 0);
  if (!name) return out("name requerido");
  const r = await fetch("./players/" + encodeURIComponent(name), {
    method: "PUT",
    headers: headers(),
    body: JSON.stringify({ level, xp: xpVal })
  });
  out(await r.json());
}
async function addXP() {
  const name = document.getElementById("pName").value.trim();
  if (!name) return out("name requerido");
  const r = await fetch("./players/addxp", {
    method: "POST",
    headers: headers(),
    body: JSON.stringify({ name, xp: 50 })
  });
  out(await r.json());
}
async function deletePlayer() {
  const name = document.getElementById("pName").value.trim();
  if (!name) return out("name requerido");
  const r = await fetch("./players/delete", {
    method: "POST",
    headers: headers(),
    body: JSON.stringify({ name })
  });
  out(await r.json());
}
document.getElementById("btnList").onclick = listPlayers;
document.getElementById("btnTop10").onclick = top10;
document.getElementById("btnUpsert").onclick = upsertPlayer;
document.getElementById("btnAddXP").onclick = addXP;
document.getElementById("btnDelete").onclick = deletePlayer;
</script>
</body>
</html>
