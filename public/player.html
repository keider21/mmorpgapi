<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MMORPG – Jugador</title>
<style>
  :root{--bg:#0f1115;--panel:#171a21;--muted:#8b97a3;--text:#e7ecf3;--accent:#ff6b3d;--ok:#29c26a;--bad:#ff4d6d;}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;background:radial-gradient(1200px 500px at 50% -150px,#251a22,transparent),var(--bg);color:var(--text)}
  .wrap{max-width:960px;margin:auto;padding:16px}
  h1{font-size:1.6rem;margin:8px 0 16px}
  .card{background:rgba(23,26,33,.9);border:1px solid #232834;border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 260px}
  label{display:block;font-size:.85rem;color:var(--muted);margin:6px 0}
  input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a2f3b;background:#0f1218;color:var(--text)}
  button{cursor:pointer;background:linear-gradient(180deg,#ff7d59,#ff5e2b);border:none;font-weight:600}
  button.secondary{background:#222833}
  button.ok{background:linear-gradient(180deg,#32d47b,#1fb463)}
  button.bad{background:linear-gradient(180deg,#ff5d7a,#ff204f)}
  pre{background:#0b0d12;border:1px solid #1c2030;border-radius:10px;padding:10px;white-space:pre-wrap;word-break:break-word}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#202633;color:#b9c4d1;font-size:.72rem;margin-right:6px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #242a38;text-align:left;font-size:.92rem}
  .meter{height:10px;background:#10141b;border-radius:999px;overflow:hidden;border:1px solid #232a38}
  .meter > span{display:block;height:100%;background:linear-gradient(90deg,#ff6b3d,#ffc93d)}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Panel del Jugador</h1>

    <!-- Perfil -->
    <div class="card">
      <div class="row">
        <div class="col">
          <label>Tu nombre</label>
          <input id="playerName" placeholder="Jugador1" />
        </div>
        <div class="col" style="align-self:flex-end">
          <div class="row">
            <div class="col"><button id="btnSaveName">Guardar nombre</button></div>
            <div class="col"><button class="secondary" id="btnForget">Olvidar</button></div>
          </div>
        </div>
      </div>
      <div style="margin-top:10px" class="row">
        <div class="col">
          <div class="tag" id="tagLevel">Nivel 1</div>
          <div class="tag" id="tagXP">XP 0/100</div>
        </div>
      </div>
    </div>

    <!-- Progreso global -->
    <div class="card">
      <h3>Progreso global</h3>
      <div class="meter"><span id="globalBar" style="width:0%"></span></div>
      <div id="globalText" class="tag" style="margin-top:8px">0%</div>
    </div>

    <!-- Batallas -->
    <div class="card">
      <h3>Batallas</h3>
      <div class="grid">
        <div>
          <label>Enemigo</label>
          <select id="enemySelect"></select>
        </div>
        <div style="align-self:end"><button id="btnAttack">¡Atacar!</button></div>
      </div>
      <div id="battleResult" style="margin-top:12px"></div>
    </div>

    <!-- Leaderboard -->
    <div class="card">
      <h3>Leaderboard (Top 10 XP)</h3>
      <button class="secondary" id="btnTop">Ver Top</button>
      <div style="margin-top:8px;overflow:auto">
        <table id="topTable">
          <thead><tr><th>#</th><th>Jugador</th><th>Nivel</th><th>XP</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Salida/debug -->
    <div class="card">
      <h3>Salida</h3>
      <pre id="out">-</pre>
    </div>
  </div>

<script>
  const API = location.origin; // tu run.app actual
  const $ = (s) => document.querySelector(s);
  const out = (obj) => { $("#out").textContent = JSON.stringify(obj, null, 2); };

  // Estado simple
  let player = { name: localStorage.getItem("playerName") || "Jugador1", level: 1, xp: 0 };

  // UI init
  $("#playerName").value = player.name;
  $("#btnSaveName").onclick = async () => {
    player.name = $("#playerName").value.trim() || "Jugador1";
    localStorage.setItem("playerName", player.name);
    alert("Nombre guardado");
    await ensurePlayer();
    await refreshHUD();
  };
  $("#btnForget").onclick = () => {
    localStorage.removeItem("playerName");
    $("#playerName").value = "";
    alert("Nombre olvidado");
  };

  const setHUD = (p) => {
    $("#tagLevel").textContent = `Nivel ${p.level ?? 1}`;
    $("#tagXP").textContent = `XP ${p.xp ?? 0}/100`;
  };

  async function ensurePlayer() {
    // crea/actualiza (no requiere admin)
    await fetch(`${API}/players/${encodeURIComponent(player.name)}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ level: player.level ?? 1, xp: player.xp ?? 0 })
    });
  }

  async function loadPlayer() {
    try {
      const r = await fetch(`${API}/players/${encodeURIComponent(player.name)}`);
      if (r.ok) {
        const data = await r.json();
        player = { ...player, ...data };
        setHUD(player);
      }
    } catch (_) {}
  }

  async function loadGlobal() {
    try {
      const g = await (await fetch(`${API}/global`)).json();
      const pct = g.goal > 0 ? Math.floor((g.current / g.goal) * 100) : 0;
      $("#globalBar").style.width = Math.min(100, Math.max(0, pct)) + "%";
      $("#globalText").textContent = `${pct}% (current ${g.current || 0} / goal ${g.goal || 0}, stage ${g.stage || 0})`;
    } catch (_) {}
  }

  async function loadEnemies() {
    const list = await (await fetch(`${API}/enemies`)).json();
    const sel = $("#enemySelect");
    sel.innerHTML = "";
    for (const e of list) {
      const opt = document.createElement("option");
      opt.value = e.id;
      opt.textContent = `${e.name} (Poder ${e.power}, XP ${e.xp})`;
      sel.appendChild(opt);
    }
  }

  $("#btnAttack").onclick = async () => {
    const enemyId = $("#enemySelect").value;
    const r = await fetch(`${API}/battle/attack`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name: player.name, enemyId })
    });
    const data = await r.json();
    out(data);

    if (data.ok) {
      const msg = data.win
        ? `✅ ¡Victoria! Ganaste ${data.xpGain} XP vs ${data.enemy.name}`
        : `❌ Derrota contra ${data.enemy.name}`;
      $("#battleResult").innerHTML = `<div class="${data.win ? "tag" : "tag"}">${msg}</div>`;
      // refrescar jugador
      await loadPlayer();
    } else {
      $("#battleResult").innerHTML = `<div class="tag">Error: ${data.error || "desconocido"}</div>`;
    }
  };

  $("#btnTop").onclick = async () => {
    const top = await (await fetch(`${API}/leaderboard?limit=10`)).json();
    const tb = $("#topTable tbody");
    tb.innerHTML = "";
    top.forEach((p, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${i+1}</td><td>${p.name || p.id}</td><td>${p.level || 1}</td><td>${p.xp || 0}</td>`;
      tb.appendChild(tr);
    });
  };

  async function refreshHUD() {
    await loadPlayer();
    await loadGlobal();
  }

  // Init
  (async () => {
    await ensurePlayer();
    await refreshHUD();
    await loadEnemies();
  })();
</script>
</body>
</html>
