<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Panel del Jugador — MMORPG</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0e13; --card:#12161f; --line:#232a38;
    --ink:#e9edf2; --muted:#9aa3b2;
    --accent1:#ff7a59; --accent2:#ff5e62;
    --good:#46d08f; --danger:#ee5d6a;
  }
  *{box-sizing:border-box}
  body{margin:0; background:radial-gradient(80% 100% at 50% -20%, #162033 0%, #0b0e13 55%) fixed; color:var(--ink); font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:980px; margin:18px auto; padding:0 14px}
  h1{font-weight:800; letter-spacing:.3px}
  .card{background:linear-gradient(180deg,#0f141dCC,#0f141dCC),var(--card); border:1px solid var(--line); border-radius:14px; padding:16px 14px; margin:14px 0; box-shadow:0 12px 40px #0006}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  @media (max-width:720px){ .row{grid-template-columns:1fr} }
  label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
  input,select{width:100%; background:#0e1420; color:var(--ink); border:1px solid var(--line); border-radius:10px; padding:12px 12px; outline:0}
  .btn{background:linear-gradient(180deg,var(--accent1),var(--accent2)); color:#101015; border:0; padding:12px 16px; border-radius:12px; font-weight:800; letter-spacing:.4px; cursor:pointer}
  .btn:disabled{filter:grayscale(.7) brightness(.8); cursor:not-allowed}
  .muted{color:var(--muted)}
  .pill{display:inline-block; background:#0f1522; border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-size:12px; margin-right:6px}
  .log{background:#0b0f18; border:1px solid #223044; border-radius:10px; padding:10px; font-family:ui-monospace,Consolas,monospace; white-space:pre-wrap}
  table{width:100%; border-collapse:collapse}
  th,td{padding:10px; border-bottom:1px solid var(--line); text-align:left; font-size:14px}
  th{colors:var(--muted); font-weight:600}
  .good{color:var(--good)} .bad{color:var(--danger)}
</style>
</head>
<body>
<div class="wrap">
  <h1>Panel del Jugador</h1>

  <div class="card">
    <label>Tu nombre</label>
    <input id="name" placeholder="Ej: Keider">
    <div class="row" style="margin-top:10px">
      <button id="saveName" class="btn">Guardar nombre</button>
      <button id="forget" class="btn" style="background:#202736;color:var(--ink)">Olvidar</button>
    </div>
    <div style="margin-top:10px">
      <span class="pill" id="p-level">Nivel 1</span>
      <span class="pill" id="p-xp">XP 0/100</span>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:6px 0 12px">Progreso global</h3>
    <div class="muted" id="worldText">0%</div>
  </div>

  <div class="card">
    <h3 style="margin:6px 0 12px">Batallas</h3>
    <label>Enemigo</label>
    <select id="enemy"></select>
    <div style="margin-top:12px">
      <button id="attack" class="btn">¡Atacar!</button>
    </div>
    <div id="dropText" class="muted" style="margin-top:10px">Sin drops…</div>
  </div>

  <div class="card">
    <h3>Leaderboard (Top 10 XP)</h3>
    <button id="btnTop" class="btn" style="margin:8px 0 12px">Ver Top</button>
    <div id="topBox" class="muted">-</div>
  </div>

  <div class="card">
    <h3>Salida</h3>
    <div id="out" class="log">-</div>
  </div>
</div>

<script>
  // ===== Config general =====
  const BASE = ""; // mismo host
  const LS_NAME_KEY = "PLAYER_NAME";

  // ===== Helpers =====
  const $ = (id)=>document.getElementById(id);
  const out = $("out");
  function log(obj){ out.textContent = JSON.stringify(obj, null, 2); }
  function showStat(p){ $("p-level").textContent = "Nivel " + (p.level||1); $("p-xp").textContent = "XP " + (p.xp||0) + "/100"; }

  // ===== Carga inicial =====
  async function loadWorld() {
    try {
      const r = await fetch(`${BASE}/global`);
      const j = await r.json();
      if (r.ok) {
        const cur = Number(j.current||0), goal = Number(j.goal||10000), st = Number(j.stage||1);
        const pct = goal>0 ? Math.floor((cur/goal)*100) : 0;
        $("worldText").textContent = `${pct}% (current ${cur} / goal ${goal}, stage ${st})`;
      } else throw j;
    } catch(e){ log(e); }
  }

  async function loadEnemies() {
    try {
      const r = await fetch(`${BASE}/public/enemies`);
      const j = await r.json();
      if (!r.ok) throw j;
      const sel = $("enemy");
      sel.innerHTML = "";
      j.forEach(e=>{
        const opt = document.createElement("option");
        opt.value = e.id;
        opt.textContent = `${e.name} (Poder ${e.power})`;
        sel.appendChild(opt);
      });
    } catch(e){
      log(e);
      $("enemy").innerHTML = "";
    }
  }

  async function loadTop() {
    try{
      const r = await fetch(`${BASE}/public/leaderboard?limit=10`);
      const j = await r.json();
      if (!r.ok) throw j;
      if (!Array.isArray(j) || !j.length){ $("topBox").textContent = "— Sin jugadores —"; return; }
      let html = `<table><thead><tr><th>#</th><th>Jugador</th><th>Nivel</th><th>XP</th></tr></thead><tbody>`;
      j.forEach((p,i)=>{ html += `<tr><td>${i+1}</td><td>${p.name||p.id}</td><td>${p.level||1}</td><td>${p.xp||0}</td></tr>`; });
      html += `</tbody></table>`;
      $("topBox").innerHTML = html;
    }catch(e){ log(e); }
  }

  // ===== Registro / nombre =====
  function getName(){ return ($("name").value||"").trim(); }
  function loadSavedName(){ const n = localStorage.getItem(LS_NAME_KEY)||""; $("name").value = n; return n; }
  async function ensurePlayer(name){
    const r = await fetch(`${BASE}/public/register`, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ name }) });
    const j = await r.json();
    if (!r.ok) throw j;
    showStat(j);
    return j;
  }

  // ===== Acciones =====
  $("saveName").onclick = async ()=>{
    const name = getName();
    if (!name) return alert("Escribe un nombre");
    try{
      localStorage.setItem(LS_NAME_KEY, name);
      const p = await ensurePlayer(name);
      log({ok:true, msg:"Nombre guardado", player:p});
    }catch(e){ log(e); }
  };

  $("forget").onclick = ()=>{
    localStorage.removeItem(LS_NAME_KEY);
    $("name").value = "";
    showStat({level:1,xp:0});
    log({ok:true,msg:"Nombre olvidado"});
  };

  $("attack").onclick = async ()=>{
    const name = getName();
    if (!name) return alert("Guarda tu nombre primero");
    const enemyId = $("enemy").value;
    if (!enemyId) return alert("No hay enemigo seleccionado");
    try{
      const r = await fetch(`${BASE}/public/attack`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ name, enemyId })
      });
      const j = await r.json();
      log(j);
      if (r.ok && j.ok){
        // feedback UI
        if (j.win){
          $("dropText").textContent = `¡Victoria! +${j.xpGain} XP contra ${j.enemy.name}`;
        } else {
          $("dropText").textContent = `Derrota… probabilidad ${Math.round(j.chance*100)}%`;
        }
        // refrescar world + top
        loadWorld();
        loadTop();
        // refrescar panel de jugador (xp aprox: sumar lo ganado si victoria)
        const curXP = Number($("p-xp").textContent.split(" ")[1]?.split("/")[0] || 0);
        const newXP = curXP + (j.win? (j.xpGain||0) : 0);
        $("p-xp").textContent = `XP ${newXP}/100`;
      } else {
        // error desde API
        // si atacaste muy rápido tras deploy y 404, aquí lo verás
      }
    }catch(e){ log(e); }
  };

  $("btnTop").onclick = loadTop;

  // ===== Start =====
  (async function init(){
    const n = loadSavedName();
    if (n){ try{ await ensurePlayer(n); }catch(_e){} }
    await Promise.all([loadWorld(), loadEnemies(), loadTop()]);
  })();
</script>
</body>
</html>
