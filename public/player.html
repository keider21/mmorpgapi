<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel del Jugador</title>
  <style>
    :root{--bg:#0b0e13;--card:#151924;--muted:#8ea0bd;--accent:#ff7846;--text:#eaeef5;--line:#22293a}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#0b0e13,#0b0e13 60%,#0d1016)}
    .wrap{max-width:920px;margin:0 auto;padding:20px}
    h1{color:#fff;margin:18px 0 10px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin:14px 0;color:var(--text)}
    label{display:block;margin:8px 0 6px;color:var(--muted);font-size:14px}
    input,select,button{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0f131a;color:var(--text)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1 1 160px}
    .cta{background:linear-gradient(90deg,#ff7846,#ff4f4f);border:none;color:#fff;font-weight:600}
    .muted{color:var(--muted);font-size:13px}
    .bar{height:8px;background:#0f131a;border-radius:6px;overflow:hidden;margin-top:8px}
    .bar>i{display:block;height:100%;background:#2f81f7;width:0%}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    pre{background:#0f131a;border:1px solid var(--line);border-radius:10px;padding:12px;overflow:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Panel del Jugador</h1>

    <div class="card">
      <label>Tu nombre</label>
      <input id="name" placeholder="Tu nombre" />
      <div class="row" style="margin-top:10px">
        <button class="cta" onclick="saveName()">Guardar nombre</button>
        <button onclick="forgetName()">Olvidar</button>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="muted">Nivel <b id="lvl">1</b></div>
        <div class="muted">XP <b id="xpText">0/100</b></div>
      </div>
      <div class="bar"><i id="xpBar"></i></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 6px">Progreso global</h3>
      <div class="bar"><i id="globalBar"></i></div>
      <div class="muted" id="globalText">0% (current 0 / goal 10000, stage 1)</div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">Batallas</h3>
      <label>Enemigo</label>
      <select id="enemy"></select>
      <div class="row" style="margin-top:10px">
        <button class="cta" onclick="attack()">¡Atacar!</button>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 6px">Leaderboard (Top 10 XP)</h3>
      <button onclick="loadTop()">Ver Top</button>
      <table id="lb">
        <thead><tr><th>#</th><th>Jugador</th><th>Nivel</th><th>XP</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h3 style="margin:0 0 6px">Salida</h3>
      <pre id="out">-</pre>
    </div>
  </div>

<script>
const out = x => document.getElementById('out').textContent =
  typeof x === 'string' ? x : JSON.stringify(x,null,2);
const base = location.origin;

const getName = () => localStorage.getItem('player_name') || '';
const setName = v => localStorage.setItem('player_name', v);

document.getElementById('name').value = getName();

function paintXP(level,xp){
  const bar = document.getElementById('xpBar');
  const cap = 100;
  const pct = Math.min(100, Math.round((xp % cap) / cap * 100));
  document.getElementById('lvl').textContent = level;
  document.getElementById('xpText').textContent = `${xp%cap}/${cap}`;
  bar.style.width = pct+'%';
}

async function saveName(){
  const n = document.getElementById('name').value.trim();
  if(!n) return alert('Escribe tu nombre');
  setName(n);
  // crea/actualiza mínimo al guardar nombre
  await fetch(`${base}/players/${encodeURIComponent(n)}`,{
    method:'PUT', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ level:1, xp:0 })
  });
  alert('Nombre guardado');
  await refreshSelf();
  await loadTop();
}

function forgetName(){
  localStorage.removeItem('player_name');
  document.getElementById('name').value='';
  paintXP(1,0);
  out('-');
}

async function refreshGlobal(){
  const r = await fetch(`${base}/global`);
  const g = await r.json();
  const pct = g.goal>0 ? Math.round((g.current/g.goal)*100) : 0;
  document.getElementById('globalBar').style.width = pct+'%';
  document.getElementById('globalText').textContent =
    `${pct}% (current ${g.current} / goal ${g.goal}, stage ${g.stage})`;
}

async function refreshSelf(){
  const n = getName();
  if(!n) return;
  const r = await fetch(`${base}/players/${encodeURIComponent(n)}`);
  if(r.ok){
    const p = await r.json();
    paintXP(p.level||1, p.xp||0);
  }
}

async function loadEnemies(){
  const sel = document.getElementById('enemy');
  sel.innerHTML='';
  const r = await fetch(`${base}/enemies`);
  const list = await r.json();
  if(!Array.isArray(list) || list.length===0){
    // si no hay enemigos, probar crear seed desde admin
    const opt = document.createElement('option');
    opt.textContent = 'No hay enemigos (pide al admin correr /seed/enemies)';
    opt.value = '';
    sel.appendChild(opt);
    return;
  }
  list.forEach(e=>{
    const opt = document.createElement('option');
    opt.value = e.id;
    opt.textContent = `${e.name} (Poder ${e.power}, +${e.rewardXp} XP)`;
    sel.appendChild(opt);
  });
}

async function loadTop(){
  const r = await fetch(`${base}/leaderboard?limit=10`);
  const t = await r.json();
  const tb = document.querySelector('#lb tbody');
  tb.innerHTML='';
  (t||[]).forEach((row,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${row.name||row.id}</td><td>${row.level||1}</td><td>${row.xp||0}</td>`;
    tb.appendChild(tr);
  });
}

async function attack(){
  const name = getName();
  if(!name) return alert('Guarda tu nombre primero');
  const enemyId = document.getElementById('enemy').value;
  if(!enemyId) return alert('Selecciona un enemigo');
  const r = await fetch(`${base}/battle`,{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ name, enemyId })
  });
  const data = await r.json();
  out(data);
  await refreshSelf();
  await loadTop();
}

(async function init(){
  await refreshGlobal();
  await refreshSelf();
  await loadEnemies();
  await loadTop();
})();
</script>
</body>
</html>
